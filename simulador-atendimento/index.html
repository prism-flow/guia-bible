<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self' https: http:;" />
  <title>Simulador de Atendimento Suporte</title>
  <meta name="description"
        content="Simulador de Atendimento Suporte — treine atendentes com clientes reais, emoção e avaliação automática." />
  <link rel="icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%230073d1'/%3E%3Cpath d='M18 40c0 6 6 10 14 10s14-4 14-10v-2H18v2z' fill='%23fff'/%3E%3Ccircle cx='24' cy='28' r='3' fill='%23fff'/%3E%3Ccircle cx='40' cy='28' r='3' fill='%23fff'/%3E%3C/svg%3E" />

  <style>
    :root{
      --bg:#0b1220; --elev-1:#0f172a; --elev-2:#0b1426;
      --brand:#0a66cc; --brand-2:#0b77f0; --brand-3:#9fd3ff;
      --text:#eaf2ff; --muted:#96a7c2; --ok:#2ecc71;
      --warn:#f5a623; --danger:#ff4d4f; --border:#1e2a44;
      --bubble-user:#0b77f0; --bubble-user-text:#fff;
      --bubble-ai:#16223a; --bubble-ai-text:#dbe9ff;
      --input-bg:#0e1730; --input-border:#22406c;
      --shadow:0 8px 28px rgba(10,102,204,.2);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans","Helvetica Neue";background:var(--bg);color:var(--text)}
    body.light{--bg:#f5f7fa;--text:#1e293b;--muted:#5f6b7a;--border:#d3dce6;--bubble-user:#0a66cc;--bubble-ai:#e8ecf4;--bubble-ai-text:#1e293b;--input-bg:#fff;--input-border:#cbd5e1}
    .app{display:grid;grid-template-rows:auto 1fr auto;height:100vh;max-width:1100px;margin:0 auto}
    /* header */
    .header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 20px;background:rgba(11,20,38,.6);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
    .brand{display:flex;align-items:center;gap:12px;font-weight:700;letter-spacing:.2px}
    .brand-badge{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand-2));display:grid;place-items:center;box-shadow:var(--shadow)}
    .brand-badge svg{opacity:.95}
    .title{font-size:18px}
    .subtitle{font-size:12px;color:var(--brand-3);font-weight:600}
    .actions{display:flex;gap:8px}
    .btn{border:1px solid var(--border);background:var(--input-bg);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
    .btn:hover{border-color:#2b4d80}
    .btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));border-color:transparent}
    .btn.icon{width:38px;height:38px;padding:0;display:grid;place-items:center}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    /* main */
    .main{display:grid;grid-template-columns:1fr 320px;gap:14px;padding:16px 20px}
    @media(max-width:1000px){.main{grid-template-columns:1fr}}
    .panel{background:linear-gradient(0deg,rgba(255,255,255,.02),transparent 40%),var(--elev-1);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .messages{padding:18px;display:flex;flex-direction:column;gap:12px;max-height:calc(100vh - 240px);overflow:auto}
    .msg{max-width:min(700px,92%);padding:12px 16px;border-radius:16px;word-wrap:break-word;white-space:pre-wrap}
    .msg.user{align-self:flex-end;background:var(--bubble-user);color:var(--bubble-user-text);border-top-right-radius:6px}
    .msg.ai{align-self:flex-start;background:var(--bubble-ai);color:var(--bubble-ai-text);border-top-left-radius:6px}
    .msg .meta{display:block;margin-top:6px;font-size:12px;color:var(--muted)}
    .composer{display:grid;grid-template-columns:1fr auto;gap:10px;padding:16px;border-top:1px solid var(--border);background:var(--elev-2);border-radius:0 0 var(--radius) var(--radius)}
    textarea{resize:none;min-height:44px;max-height:160px;border-radius:12px;padding:12px 14px;background:var(--input-bg);color:var(--text);border:1px solid var(--input-border);outline:none}
    textarea:focus{border-color:#3267a8;box-shadow:0 0 0 3px rgba(11,119,240,.15)}
    .send{min-width:110px}
    /* side */
    .side{padding:16px;display:flex;flex-direction:column;gap:12px}
    .card{border:1px solid var(--border);border-radius:12px;padding:12px;background:rgba(11,22,40,.6)}
    .card h3{margin:0 0 8px;font-size:14px;color:var(--brand-3);letter-spacing:.3px}
    .hint{font-size:12px;color:var(--muted)}
    .toast{position:fixed;bottom:16px;right:16px;background:#112241;color:#cfe1ff;padding:10px 12px;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);opacity:0;transform:translateY(8px);transition:all .2s}
    .toast.show{opacity:1;transform:translateY(0)}
  </style>
</head>

<body>
  <div class="app">
    <header class="header" role="banner">
      <div class="brand">
        <div class="brand-badge" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 1v3M12 20v3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12M1 12h3M20 12h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12"/>
            <circle cx="12" cy="12" r="4"/>
          </svg>
        </div>
        <div>
          <div class="title">Simulador de Atendimento Suporte</div>
          <div class="subtitle">Treino realista com emoção e avaliação automática</div>
        </div>
      </div>
      <div class="actions">
        <button id="btnClear" class="btn icon" title="Limpar conversa">🧹</button>
        <button id="btnTheme" class="btn icon" title="Alternar tema">🌗</button>
      </div>
    </header>

    <div class="main">
      <section class="panel">
        <div id="messages" class="messages" role="log"></div>
        <div class="composer">
          <textarea id="userInput" placeholder="Sua resposta… (Shift+Enter para nova linha)"></textarea>
          <button id="sendBtn" class="btn primary send" type="button">Enviar</button>
        </div>
      </section>

      <aside class="side">
        <div class="card">
          <h3>Sobre</h3>
          <p class="hint">Este simulador cria clientes com emoções reais (😠, 😕, 😊) e gera automaticamente uma <strong>avaliação técnica</strong> de cada fase, com nota de 1 a 5.</p>
        </div>

        <div class="card">
          <h3>Atalhos</h3>
          <ul class="hint" style="margin:0 0 0 18px">
            <li>Enter envia</li>
            <li>Shift+Enter quebra linha</li>
            <li>🧹 Limpa conversa</li>
            <li>🌗 Alterna tema claro/escuro</li>
          </ul>
        </div>
      </aside>
    </div>

    <div id="toast" class="toast"></div>
  </div>

  <script>
  'use strict';
  /* ===== VARIÁVEIS GLOBAIS ===== */
  const CHAT_ENDPOINT = "/.netlify/functions/chat";
  const TOTAL_FASES = 6;
  let FASE_ATUAL = 1;
  let ultimaFaseConcluida = false;
/* ===== SYSTEM PROMPT ===== */
const SYSTEM_PROMPT = `Você é o CLIENTE de um provedor de internet.
Jamais aja como atendente. Fale como cliente real com emoções (ex: [😠 Irritado]).
Não exiba cabeçalhos ou avisos de treinamento.
Ao fim de cada atendimento, faça a AVALIAÇÃO TÉCNICA DA FASE conforme o formato obrigatório (nota 1-5, sem 10/10).`;

/* ===== INICIAL ===== */
const INITIAL_GREETING = `👋 **Bem-vindo ao Simulador de Atendimento!**

Para começar um atendimento, digite: **INICIAR**`;

const store = {
  load(){ try{return JSON.parse(localStorage.getItem('simulador-history')||'null')||[]}catch{return[]} },
  save(h){ try{localStorage.setItem('simulador-history',JSON.stringify(h))}catch{} },
  clear(){ try{localStorage.removeItem('simulador-history')}catch{} }
};

let chatHistory = store.load();
if(chatHistory.length===0){chatHistory=[{role:'system',content:SYSTEM_PROMPT},{role:'assistant',content:INITIAL_GREETING}];}

/* ===== ELEMENTOS ===== */
const $messages=document.getElementById('messages');
const $input=document.getElementById('userInput');
const $send=document.getElementById('sendBtn');
const $btnTheme=document.getElementById('btnTheme');
const $btnClear=document.getElementById('btnClear');
const $toast=document.getElementById('toast');
let controller=null;

/* ===== FUNÇÕES DE UI ===== */
function toast(msg){$toast.textContent=msg;$toast.classList.add('show');setTimeout(()=>{$toast.classList.remove('show')},2000);}
function escapeHTML(s){return String(s).replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));}
function markdownSafe(t){return escapeHTML(t).replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');}
function addMessage(role,text){const el=document.createElement('div');el.className=`msg ${role==='assistant'?'ai':'user'}`;el.innerHTML=markdownSafe(text);const meta=document.createElement('span');meta.className='meta';meta.textContent=new Date().toLocaleTimeString();el.appendChild(meta);$messages.appendChild(el);$messages.scrollTop=$messages.scrollHeight;}
function applyTheme(){document.body.classList.toggle('light');toast(document.body.classList.contains('light')?'Tema claro':'Tema escuro');}
function boasVindas(){addMessage('assistant',INITIAL_GREETING);}
function extrairNotas(){
  const notas=chatHistory.filter(m=>m.role==='assistant'&&/Nota final:\s*\d(\.\d)?\/5/.test(m.content))
    .map(m=>parseFloat(m.content.match(/Nota final:\s*(\d(\.\d)?)/)[1]));
  return notas;
}
function gerarAvaliacaoFinal(){
  const notas=extrairNotas();if(!notas.length)return;
  const media=(notas.reduce((a,b)=>a+b,0)/notas.length).toFixed(2);
  let texto=`📊 **Avaliação Final do Treinamento**\n\nMédia das notas: **${media}/5**\n\n`;
  texto+=`**Síntese:**\n- Pontos fortes: empatia, clareza, técnica evolutiva.\n- Melhorias: seguir todos os protocolos (saudação, CPF, encerramento humanizado).\n\n`;
  texto+=`**Treinamento concluído.** Digite **REINICIAR** para reiniciar o simulador.`;
  addMessage('assistant',texto);
}

/* ===== ROTEIRO DE FASES ===== */
const PHASES=[
{id:1,nome:"Sem conexão (LOS vermelha)",cliente:"[😫 Desesperado] \"Minha internet caiu e a luz LOS do modem pisca vermelha!\"",criterios:"Solicitar fotos, confirmar LOS vermelho, reiniciar, apertar conector, se não voltar agendar visita."},
{id:2,nome:"Oscilação/Lentidão",cliente:"[😤 Irritado] \"A internet tá caindo e lenta, pago 500 Mega!\"",criterios:"Classificar tipo, explicar 2.4 x 5GHz, pedir teste velocidade, orientar uso de cabo, checar compatibilidade, ou agendar visita."},
{id:3,nome:"Instabilidade em jogos",cliente:"[😕 Chateado] \"Ping alto no PS5 e PC, Fortnite injogável!\"",criterios:"Verificar pacotes, horários, orientar uso de cabo, abrir chamado se persistir."},
{id:4,nome:"VPN corporativa",cliente:"[🤔 Pensativo] \"Só a VPN do trabalho não conecta.\"",criterios:"Confirmar exclusividade, nome da VPN, explicar que é remoto, orientar acionar TI."},
{id:5,nome:"Equipamento secundário",cliente:"[😕 Confuso] \"Depois do repetidor, ficou tudo travando.\"",criterios:"Pedir desconectar repetidor, testar, explicar conflito IP e manter desligado."},
{id:6,nome:"Instabilidade no IPTV",cliente:"[😠 Irritado] \"IPTV trava o tempo todo, resto tá normal.\"",criterios:"Testar cabo, confirmar que é só IPTV, explicar limitação de serviço clandestino e orientar contatar revendedor."}
];

/* ===== FUNÇÃO PARA FASE ===== */
function contextoFaseMsg(){
  const f=PHASES[FASE_ATUAL-1];
  return {role:"user",content:
`Contexto (NÃO REVELE):
Fase ${f.id}/${TOTAL_FASES} - "${f.nome}"

Inicie como CLIENTE: ${f.cliente}
Espere o atendente cumprimentar e pedir CPF/CNPJ antes de continuar.

Critérios: ${f.criterios}

Ao identificar encerramento, gere AVALIAÇÃO no formato:
📝 **Avaliação Técnica da Fase**
✅ Pontos positivos: ...
⚠️ Oportunidades de melhoria: ...
🧪 Evidências: "..."
💡 Plano de melhoria (3 bullets curtas)
🧾 Nota final: X/5

Depois escreva:
👉 **Digite PROXIMO para iniciar a próxima fase.**
Na última fase, gere também a 📊 **Avaliação Final do Treinamento**.`};
}

/* ===== REDE ===== */
async function callOpenAI(msgs){
  const payload={model:"gpt-4o-mini",messages:msgs,temperature:0.6};
  const r=await fetch(CHAT_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  const j=await r.json();
  return j?.choices?.[0]?.message?.content||"⚠️ Erro ao obter resposta.";
}

/* ===== ENVIO ===== */
async function sendMessage(){
  const text=($input.value||'').trim();
  if(!text)return;
  addMessage('user',text);
  $input.value='';$send.disabled=true;
  chatHistory.push({role:'user',content:text});
  store.save(chatHistory);

  if(/^iniciar$/i.test(text)){
    FASE_ATUAL=1;ultimaFaseConcluida=false;
    const fase=contextoFaseMsg();
    chatHistory.push(fase);
    store.save(chatHistory);
    const reply=await callOpenAI(chatHistory);
    addMessage('assistant',reply);
    chatHistory.push({role:'assistant',content:reply});
    store.save(chatHistory);
    return;
  }

  if(/^proximo$/i.test(text)){
    if(!ultimaFaseConcluida){addMessage('assistant',"⚠️ Você só pode digitar **PROXIMO** após concluir e receber a avaliação da fase atual.");return;}
    FASE_ATUAL++;
    if(FASE_ATUAL> TOTAL_FASES){gerarAvaliacaoFinal();return;}
    ultimaFaseConcluida=false;
    const fase=contextoFaseMsg();
    chatHistory.push(fase);store.save(chatHistory);
    const reply=await callOpenAI(chatHistory);
    addMessage('assistant',reply);
    chatHistory.push({role:'assistant',content:reply});
    store.save(chatHistory);
    return;
  }

  if(/^reiniciar$/i.test(text)){
    store.clear();location.reload();return;
  }

  const reply=await callOpenAI(chatHistory);
  addMessage('assistant',reply);
  chatHistory.push({role:'assistant',content:reply});
  store.save(chatHistory);

  if(/Nota final:\s*\d(\.\d)?\/5/i.test(reply)){ultimaFaseConcluida=true;}
}

/* ===== EVENTOS ===== */
window.addEventListener('DOMContentLoaded',()=>{
  const light=localStorage.getItem('theme')==='light';
  if(light)document.body.classList.add('light');
  $send.disabled=!$input.value.trim();
  $input.addEventListener('input',()=>{$send.disabled=!$input.value.trim();});
  $send.addEventListener('click',sendMessage);
  $input.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}});
  $btnClear.onclick=()=>{if(confirm('Limpar conversa?')){store.clear();location.reload();}};
  $btnTheme.onclick=()=>{document.body.classList.toggle('light');localStorage.setItem('theme',document.body.classList.contains('light')?'light':'dark');};
  $messages.innerHTML='';chatHistory.forEach(m=>{if(m.role!=='system')addMessage(m.role,m.content);});
  $input.focus();
  if(chatHistory.length<=1||!chatHistory.some(m=>m.role==='assistant')){boasVindas();}
});
  </script>
</body>
</html>
