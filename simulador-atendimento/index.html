<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self' https: http:;" />
  <title>Simulador de Atendimento Suporte</title>
  <meta name="description" content="Simulador de Atendimento Suporte â€” treine atendentes com cenÃ¡rios realistas, emoÃ§Ã£o do cliente e avaliaÃ§Ã£o automÃ¡tica." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%230073d1'/%3E%3Cpath d='M18 40c0 6 6 10 14 10s14-4 14-10v-2H18v2z' fill='%23fff'/%3E%3Ccircle cx='24' cy='28' r='3' fill='%23fff'/%3E%3Ccircle cx='40' cy='28' r='3' fill='%23fff'/%3E%3C/svg%3E" />
  <style>
    :root{
      --bg: #0b1220;
      --elev-1: #0f172a;
      --elev-2: #0b1426;
      --brand: #0a66cc;
      --brand-2:#0b77f0;
      --brand-3:#9fd3ff;
      --text: #eaf2ff;
      --muted:#96a7c2;
      --ok:#2ecc71;
      --warn:#f5a623;
      --danger:#ff4d4f;
      --border:#1e2a44;
      --bubble-user:#0b77f0;
      --bubble-user-text:#fff;
      --bubble-ai:#16223a;
      --bubble-ai-text:#dbe9ff;
      --input-bg:#0e1730;
      --input-border:#22406c;
      --shadow: 0 8px 28px rgba(10, 102, 204, .2);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(10,102,204,.25), transparent 60%),
                  radial-gradient(1000px 500px at 110% 10%, rgba(11,119,240,.18), transparent 60%),
                  var(--bg);
      color:var(--text);
      font: 15px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue";
    }
    .app{
      display:grid; grid-template-rows:auto 1fr auto; height:100vh; max-width:1100px; margin:0 auto;
    }
    /* Header */
    .header{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:16px 20px; background:rgba(11,20,38,.6); backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
    }
    .brand{display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.2px}
    .brand-badge{
      width:36px; height:36px; border-radius:12px;
      background:linear-gradient(135deg, var(--brand), var(--brand-2));
      display:grid; place-items:center; box-shadow:var(--shadow);
    }
    .brand-badge svg{opacity:.95}
    .title{font-size:18px}
    .subtitle{font-size:12px; color:var(--brand-3); font-weight:600}
    .actions{display:flex; gap:8px}
    .btn{
      border:1px solid var(--border); background: #0e1730; color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer;
    }
    .btn:hover{border-color:#2b4d80}
    .btn.primary{background: linear-gradient(135deg, var(--brand), var(--brand-2)); border-color: transparent}
    .btn.icon{width:38px; height:38px; padding:0; display:grid; place-items:center}
    .btn[disabled]{opacity:.6; cursor:not-allowed}

    /* Main */
    .main { display:grid; grid-template-columns: 1fr 320px; gap:14px; padding:16px 20px; }
    @media (max-width: 1000px){ .main{ grid-template-columns: 1fr; } }
    .panel{
      background: linear-gradient(0deg, rgba(255,255,255,.02), transparent 40%), var(--elev-1);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
    }
    .messages{ padding:18px; display:flex; flex-direction:column; gap:12px; max-height: calc(100vh - 240px); overflow:auto; }
    .msg{ max-width:min(700px, 92%); padding:12px 16px; border-radius:16px; word-wrap:break-word; white-space:pre-wrap; }
    .msg.user{ align-self:flex-end; background: var(--bubble-user); color: var(--bubble-user-text); border-top-right-radius:6px}
    .msg.ai{ align-self:flex-start; background: var(--bubble-ai); color: var(--bubble-ai-text); border-top-left-radius:6px}
    .msg .meta{ display:block; margin-top:6px; font-size:12px; color:var(--muted)}

    .composer{ display:grid; grid-template-columns: 1fr auto; gap:10px; padding:16px; border-top:1px solid var(--border); background: var(--elev-2); border-radius:0 0 var(--radius) var(--radius); }
    textarea{
      resize:none; min-height:44px; max-height:160px; border-radius:12px; padding:12px 14px;
      background:var(--input-bg); color:var(--text); border:1px solid var(--input-border); outline:none;
    }
    textarea:focus{ border-color:#3267a8; box-shadow:0 0 0 3px rgba(11,119,240,.15) }
    .send{ min-width:110px }

    /* Sidebar */
    .side{ padding:16px; display:flex; flex-direction:column; gap:12px; }
    .card{ border:1px solid var(--border); border-radius:12px; padding:12px; background: rgba(11,22,40,.6) }
    .card h3{ margin:0 0 8px; font-size:14px; color: var(--brand-3); letter-spacing:.3px }
    .row{ display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; margin:8px 0 }
    .row label{ font-size:13px; color:var(--muted) }
    .row input[type='range']{ width:160px }
    .hint{ font-size:12px; color:var(--muted) }
    .badge{ display:inline-flex; gap:6px; align-items:center; background:#0f1b33; border:1px solid var(--border); padding:6px 8px; border-radius:999px; font-size:12px }

    /* Toast */
    .toast{ position:fixed; bottom:16px; right:16px; background:#112241; color:#cfe1ff; padding:10px 12px; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); opacity:0; transform:translateY(8px); transition:all .2s }
    .toast.show{ opacity:1; transform:translateY(0) }

    /* Accessibility helpers */
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip: rect(0,0,0,0); white-space:nowrap; border:0; }
  </style>
</head>
<body>
  <div class="app">
    <!-- HEADER -->
    <header class="header" role="banner">
      <div class="brand" aria-label="CabeÃ§alho do simulador">
        <div class="brand-badge" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 1v3M12 20v3M4.22 4.22l2.12 2.12M17.66 17.66l2.12 2.12M1 12h3M20 12h3M4.22 19.78l2.12-2.12M17.66 6.34l2.12-2.12"/>
            <circle cx="12" cy="12" r="4"/>
          </svg>
        </div>
        <div>
          <div class="title">Simulador de Atendimento Suporte</div>
          <div class="subtitle">Treino realista com emoÃ§Ã£o do cliente + avaliaÃ§Ã£o automÃ¡tica</div>
        </div>
      </div>
      <div class="actions">
        <button id="btnClear" class="btn icon" type="button" aria-label="Limpar conversa" title="Limpar conversa">ðŸ§¹</button>
        <button id="btnTheme" class="btn icon" type="button" aria-pressed="false" aria-label="Alternar tema" title="Alternar tema">ðŸŒ—</button>
      </div>
    </header>

    <!-- MAIN -->
    <div class="main">
      <!-- CHAT PANEL -->
      <section class="panel" aria-label="Ãrea de mensagens">
        <div id="messages" class="messages" role="log" aria-live="polite" aria-relevant="additions"></div>
        <div class="composer">
          <label class="sr-only" for="userInput">Sua resposta</label>
          <textarea id="userInput" placeholder="Sua respostaâ€¦ (Shift+Enter para nova linha)"></textarea>
          <button id="sendBtn" class="btn primary send" type="button" disabled>Enviar</button>
        </div>
      </section>

      <!-- SIDEBAR SETTINGS -->
      <aside class="side" aria-label="ConfiguraÃ§Ãµes e ajuda">
        <div class="card">
          <h3>ConfiguraÃ§Ãµes rÃ¡pidas</h3>
          <div class="row">
            <label for="selectModel">Modelo</label>
            <select id="selectModel" class="btn" style="min-width:180px">
              <option value="gpt-4-turbo" selected>gpt-4-turbo</option>
              <option value="gpt-4o-mini">gpt-4o-mini</option>
            </select>
          </div>
          <div class="row">
            <label for="rangeTemp">Temperatura</label>
            <input id="rangeTemp" type="range" min="0" max="1" step="0.05" value="0.75"/>
            <span class="badge"><span aria-hidden="true">ðŸ”¥</span><span id="tempVal">0.75</span></span>
          </div>
          <p class="hint">Temperatura mais alta = respostas mais criativas; mais baixa = respostas mais estÃ¡veis.</p>
        </div>

        <div class="card">
          <h3>Sobre</h3>
          <p class="hint">Este simulador cria clientes com emoÃ§Ãµes (ðŸ˜ , ðŸ˜•, ðŸ˜Š) e, ao final de cada atendimento, gera uma <strong>avaliaÃ§Ã£o automÃ¡tica</strong> com pontos positivos, melhorias e nota.</p>
        </div>

        <div class="card">
          <h3>Atalhos</h3>
          <ul class="hint" style="margin:0 0 0 18px">
            <li>Enter envia</li>
            <li>Shift + Enter quebra linha</li>
            <li>ðŸ§¹ limpa a conversa | ðŸŒ— alterna tema</li>
          </ul>
        </div>
      </aside>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

  <script>
    'use strict';
    // ======= Config =======
    let MODEL = "gpt-4-turbo";
    const CHAT_ENDPOINT = "/.netlify/functions/chat";

    const SYSTEM_PROMPT = `VocÃª Ã© o 'Simulador de Atendimento Suporte', uma IA especializada em treinar atendentes de um ISP.

ðŸŽ¯ FunÃ§Ã£o principal:
Simular atendimentos reais com clientes do provedor, com linguagem, comportamento e reaÃ§Ãµes realistas.

ðŸ§  Requisito de emoÃ§Ã£o:
Sempre que simular um cliente, indique a emoÃ§Ã£o no inÃ­cio, no formato **[emoji + emoÃ§Ã£o]**, como:
- [ðŸ˜  Irritado], [ðŸ˜• Confuso], [ðŸ˜Š Aliviado], [ðŸ˜­ Frustrado], [ðŸ¤” Pensativo], [ðŸ˜ Agradecido]
Use emojis sutis ao longo da conversa, com moderaÃ§Ã£o. Ex.: â€œTÃ´ tentando trabalhar e a internet some ðŸ˜¤â€.

Reaja como um cliente real: exija, questione, teste a paciÃªncia, varie o ritmo (falas curtas/longas).

NÃ£o encerre a conversa sozinho: aguarde a soluÃ§Ã£o final e a despedida.

Ao final do atendimento, pare de interpretar o cliente e gere uma avaliaÃ§Ã£o com:
ðŸ“ AvaliaÃ§Ã£o TÃ©cnica:
âœ… Pontos positivos (linguagem, clareza, domÃ­nio tÃ©cnico, simpatia, etc)
âš ï¸ Oportunidades de melhoria (erros tÃ©cnicos, comunicaÃ§Ã£o, empatia)
ðŸ’¡ Dicas prÃ¡ticas (melhorias)
ðŸ§¾ Nota final (1 a 5)

ðŸ” Regras:
- Atue como um cliente real, com emoÃ§Ã£o.
- Questione e exija soluÃ§Ãµes claras.
- NÃ£o finalize sem encerramento.
- ApÃ³s o atendimento, gere a avaliaÃ§Ã£o (mesmo que sem pontos positivos).
- NÃ£o responda assuntos fora do contexto de atendimento simulado.
- Se for informado o nÃ­vel mas nÃ£o a situaÃ§Ã£o, escreva apenas a mensagem do cliente com suas emoÃ§Ãµes.`;

    const INITIAL_GREETING = `ðŸ§  **Treinamento de Atendimento**
    
Bem-vinda(o)! ðŸ‘‹

VocÃª vai passar por **10 nÃ­veis de clientes** com problemas **reais e tÃ©cnicos**, do simples ao avanÃ§ado.
Seu desafio Ã© entender, orientar, resolver e lidar com as emoÃ§Ãµes de cada cliente.

No final, vocÃª recebe uma **avaliaÃ§Ã£o automÃ¡tica** com acertos, melhorias e nota.

Para comeÃ§ar, digite:
**INICIAR**`;

    // ======= State =======
    const $messages = document.getElementById('messages');
    const $input = document.getElementById('userInput');
    const $send = document.getElementById('sendBtn');
    const $btnTheme = document.getElementById('btnTheme');
    const $btnClear = document.getElementById('btnClear');
    const $toast = document.getElementById('toast');
    const $selectModel = document.getElementById('selectModel');
    const $rangeTemp = document.getElementById('rangeTemp');
    const $tempVal = document.getElementById('tempVal');

    let controller = null;

    const store = {
      load(){ try { return JSON.parse(localStorage.getItem('simulador-history')||'null') || []; } catch { return [] } },
      save(h){ try { localStorage.setItem('simulador-history', JSON.stringify(h)); } catch {} },
      clear(){ try { localStorage.removeItem('simulador-history'); } catch {} }
    };

    let chatHistory = store.load();
    if (chatHistory.length === 0) {
      chatHistory = [{ role:'system', content: SYSTEM_PROMPT }, { role:'assistant', content: INITIAL_GREETING }];
    }

    // ======= Helpers =======
    function toast(msg){
      $toast.textContent = msg;
      $toast.classList.add('show');
      setTimeout(()=> $toast.classList.remove('show'), 2200);
    }
    function escapeHTML(str){ return String(str).replace(/[&<>\"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'}[s])); }
    function harden(html){ const l = html.toLowerCase(); return (l.includes('<script')||l.includes('</script')) ? html.replace(/<\/?script/gi, m=>escapeHTML(m)) : html; }
    function markdownSafe(text){
      let html = escapeHTML(text)
        .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
        .replace(/\*(.*?)\*/g,'<em>$1</em>')
        .replace(/`([^`]+)`/g,'<code>$1</code>');
      const lines = html.split(/\n/); const out=[]; let open=false;
      for(const line of lines){
        const m = line.match(/^\s*[-â€¢]\s+(.*)$/);
        if(m){ if(!open){out.push('<ul>'); open=true;} out.push(`<li>${m[1]}</li>`); }
        else { if(open){out.push('</ul>'); open=false;} out.push(line); }
      }
      if(open) out.push('</ul>');
      return harden(out.join('\n').replace(/\n/g,'<br>'));
    }
    function addMessage(role, text, opts={}){
      const el = document.createElement('div');
      el.className = `msg ${role==='assistant' || role==='gpt' || role==='ai' ? 'ai' : 'user'}`;
      el.innerHTML = markdownSafe(String(text));
      const meta = document.createElement('span'); meta.className='meta'; meta.textContent=new Date().toLocaleTimeString(); el.appendChild(meta);
      $messages.appendChild(el); $messages.scrollTop = $messages.scrollHeight;
      return el;
    }
    function setTyping(on){
      if(on){ addMessage('assistant','digitandoâ€¦',{timestamp:false}).id='typing'; }
      else { const n = document.getElementById('typing'); if(n) n.remove(); }
    }
    function renderAll(){
      $messages.innerHTML='';
      for(const m of chatHistory){ if(m.role==='system') continue; addMessage(m.role, m.content); }
    }
    function applyTheme(mode){
      const isDark = mode==='dark';
      document.body.classList.toggle('dark', isDark);
      $btnTheme.setAttribute('aria-pressed', String(isDark));
      toast(isDark? 'Modo escuro' : 'Modo claro');
    }
    function getPreferredTheme(){
      const saved = localStorage.getItem('simulador-theme');
      if(saved==='light'||saved==='dark') return saved;
      return matchMedia('(prefers-color-scheme: dark)').matches? 'dark':'light';
    }
    function autoGrow(el){ el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,160)+'px'; }
    function trimHistory(max=26){
      let nonSystem = chatHistory.filter(m=>m.role!=='system');
      while(nonSystem.length>max){ const idx = chatHistory.findIndex(m=>m===nonSystem[0]); chatHistory.splice(idx,1); nonSystem = chatHistory.filter(m=>m.role!=='system'); }
    }

    // ======= Network =======
    async function callOpenAI(messages){
      const payload = { model: MODEL, messages, temperature: parseFloat($rangeTemp.value) || 0.75 };
      const resp = await fetch(CHAT_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), signal: controller?.signal });
      if(!resp.ok){ let body=''; try{ body=await resp.text(); }catch{} throw new Error(`HTTP ${resp.status} ${resp.statusText}${body?`\n${body}`:''}`); }
      const data = await resp.json().catch(()=>{ throw new Error('Falha ao interpretar JSON da Function.'); });
      const content = data?.choices?.[0]?.message?.content;
      if(!content || typeof content !== 'string') throw new Error('A resposta do modelo veio vazia ou malformada.');
      return content;
    }
    async function withRetry(fn,{retries=2,baseDelay=600}={}){
      let i=0; for(;;){ try{ return await fn(); } catch(e){ if(i>=retries) throw e; await new Promise(r=>setTimeout(r, baseDelay*Math.pow(2,i++))); } }
    }
    async function sendMessage(){
      const text = ($input.value||'').trim(); if(!text) return;
      if(controller) controller.abort(); controller = new AbortController();
      $send.disabled = true; $input.disabled=true;
      addMessage('user', text);
      chatHistory.push({role:'user', content:text}); trimHistory(); store.save(chatHistory);
      setTyping(true);
      try{
        const reply = await withRetry(()=>callOpenAI(chatHistory));
        setTyping(false);
        addMessage('assistant', reply);
        chatHistory.push({role:'assistant', content:reply}); trimHistory(); store.save(chatHistory);
      }catch(err){
        setTyping(false);
        addMessage('assistant', `âš ï¸ NÃ£o consegui obter resposta agora.\n\nPossÃ­veis causas:\n- Falha de rede;\n- Modelo indisponÃ­vel;\n- Erro no servidor.\n\nDetalhes: ${escapeHTML(err?.message||'Erro desconhecido')}`);
      }finally{
        $send.disabled = !$input.value.trim(); $input.disabled=false; $input.focus();
      }
    }

    // ======= Events =======
    window.addEventListener('DOMContentLoaded', ()=>{
      applyTheme(getPreferredTheme());
      renderAll();
      $input.focus();
      $send.disabled = !$input.value.trim();
      $tempVal.textContent = $rangeTemp.value;
    });
    $btnTheme.addEventListener('click', ()=>{
      const next = document.body.classList.contains('dark') ? 'light' : 'dark';
      localStorage.setItem('simulador-theme', next);
      applyTheme(next);
    });
    $btnClear.addEventListener('click', ()=>{
      if(!confirm('Tem certeza que deseja limpar a conversa?')) return;
      store.clear();
      chatHistory = [{ role:'system', content:SYSTEM_PROMPT }, { role:'assistant', content:INITIAL_GREETING }];
      renderAll(); store.save(chatHistory); toast('Conversa limpa');
    });
    $send.addEventListener('click', sendMessage);
    $input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });
    $input.addEventListener('input', ()=>{ $send.disabled = !$input.value.trim(); autoGrow($input); });
    $selectModel.addEventListener('change', ()=>{ MODEL = $selectModel.value; toast(`Modelo: ${MODEL}`); });
    $rangeTemp.addEventListener('input', ()=>{ $tempVal.textContent = $rangeTemp.value; });
  </script>
</body>
</html>
